<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Block-Breaker</title>
        <style media="screen">
            #id-canvas {
                border: 1px solid black;
            }
        </style>
        <script type="text/javascript" src="utils.js"></script>
        <script type="text/javascript" src="game.js"></script>
        <script type="text/javascript" src="block.js"></script>
        <script type="text/javascript" src="ball.js"></script>
        <script type="text/javascript" src="paddle.js"></script>
        <script type="text/javascript" src="level.js"></script>
    </head>
    <body>
        <canvas id="id-canvas" width="400" height="300"></canvas>
        <hr>
        <input type="range" id=id-input-speed  value="1">
    </body>
    <script type="text/javascript">

        var enableDebugMode = function(enable) {
            if(!enable) {
                return;
            }
            window.addEventListener("keydown", function(event) {
                var k = event.key
                if(k === "p") {
                    // 暂停功能
                    paused = !paused
                }else if ("123456789".includes(k)) {
                    // 关卡
                    blocks = loadLeves(Number(k))
                }
            })

            // 控制速度
            document.querySelector("#id-input-speed").addEventListener("input", function(e) {
                log("event", e.target.value)
                window.fps = Number(e.target.value)
            })
        }

        var loadLeves = function(n) {
            n = n - 1
            var level = leves[n]
            var blocks = []
            for (var i = 0; i < level.length; i++) {
                var p = level[i]
                var b = Block(p)
                // b.x = p[0]
                // b.y = p[1]
                blocks.push(b)
            }
            return blocks
        }

        var __main = function() {
            enableDebugMode(true)
            var game = Game(30)

            var paddle = Paddle()
            var ball = Ball()

            // var blocks = []
            // for (var i = 0; i < 3; i++) {
            //     var b = Block()
            //     b.x = i * 150
            //     b.y = 50
            //     blocks.push(b)
            // }
            blocks = loadLeves(1)
            game.registerAction("a", function() {
                paddle.moveLeft()
            })

            game.registerAction("d", function() {
                paddle.moveRight()
            })

            game.registerAction("f", function() {
                ball.fire()
            })

            game.update = function() {
                if(paused) {
                    return;
                }
                ball.move()
                if(paddle.collide(ball)) {
                    ball.rebound()
                }
                // log("blocks", blocks.length)
                for (var i = 0; i < blocks.length; i++) {
                    var b = blocks[i]
                    if(b.collide(ball)) {
                        log("block 相撞")
                        b.kill()
                        ball.rebound()
                    }
                }
            }

            game.draw = function() {
                game.drawImage(paddle)
                game.drawImage(ball)
                // log("blocks", blocks.length)
                for (var i = 0; i < blocks.length; i++) {
                    var b = blocks[i]
                    // draw
                    if(b.alive) {
                        game.drawImage(b)
                    }
                }

            }
        }

        __main()
    </script>
</html>
